<div class="header bg-gradient-danger pb-8 pt-5 pt-md-8">
    <div class="container-fluid">
        <div class="header-body">
        </div>
    </div>
</div>
<div class="container-fluid mt--7">
    <div class="row">
        <div class="col">
            <div class="card shadow">
                <div class="card-header border-0">
                    <h3 class="mb-0">{{ editMode ? 'Modifier le Terrain' : 'Nos Terrains de Padel' }}</h3>
                    <button *ngIf="authService.getUserRole() === 'ADMIN' && !showForm"
                        class="btn btn-sm btn-primary float-right" (click)="showForm = true">Nouveau Terrain</button>
                    <button *ngIf="editMode" class="btn btn-sm btn-secondary float-right mr-2"
                        (click)="cancelEdit()">Annuler Modification</button>
                </div>

                <!-- Add Terrain Form (Admin only) -->
                <div class="card-body" *ngIf="showForm">
                    <form (ngSubmit)="addTerrain()">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <input type="text" class="form-control" placeholder="Nom"
                                        [(ngModel)]="newTerrain.nom" name="nom" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <input type="text" class="form-control" placeholder="Localisation"
                                        [(ngModel)]="newTerrain.localisation" name="localisation" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <input type="number" class="form-control" placeholder="Prix"
                                        [(ngModel)]="newTerrain.prix" name="prix" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <input type="text" class="form-control" placeholder="État (ex: DISPONIBLE)"
                                        [(ngModel)]="newTerrain.etat" name="etat" required>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <textarea class="form-control" placeholder="Description"
                                [(ngModel)]="newTerrain.description" name="description"></textarea>
                        </div>
                        <button type="submit" class="btn btn-success">Enregistrer</button>
                    </form>
                </div>

                <!-- Add Slot Form (Admin only) -->
                <div class="card-body border-top bg-secondary p-4" *ngIf="selectedTerrainId">
                    <h4 class="mb-4">Ajouter un Créneau</h4>
                    <form (ngSubmit)="addSlot()">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="form-control-label">Date</label>
                                    <input type="date" class="form-control form-control-alternative"
                                        [(ngModel)]="slotForm.date" name="sDate" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="form-control-label">Début</label>
                                    <input type="time" class="form-control form-control-alternative"
                                        [(ngModel)]="slotForm.start" name="sStart" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="form-control-label">Fin</label>
                                    <input type="time" class="form-control form-control-alternative"
                                        [(ngModel)]="slotForm.end" name="sEnd" required>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary btn-sm">Ajouter le créneau</button>
                        <button type="button" class="btn btn-link btn-sm text-danger"
                            (click)="selectedTerrainId = null">Annuler</button>
                    </form>
                </div>

                <div class="table-responsive">
                    <table class="table align-items-center table-flush">
                        <thead class="thead-light">
                            <tr>
                                <th scope="col">Nom</th>
                                <th scope="col">Localisation</th>
                                <th scope="col">Prix</th>
                                <th scope="col">État</th>
                                <th scope="col">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let t of terrains">
                                <td>{{ t.nom }}</td>
                                <td>{{ t.localisation }}</td>
                                <td>{{ t.prix }} TND</td>
                                <td>{{ t.etat }}</td>
                                <td>
                                    <ng-container *ngIf="authService.getUserRole() === 'ADMIN'">
                                        <button class="btn btn-sm btn-info" (click)="onEdit(t)">Modifier</button>
                                        <button class="btn btn-sm btn-default"
                                            (click)="loadSlots(t.id)">Créneaux</button>
                                        <button class="btn btn-sm btn-primary" (click)="openSlotForm(t.id)">+</button>
                                        <button class="btn btn-sm btn-danger"
                                            (click)="deleteTerrain(t.id)">Supprimer</button>
                                    </ng-container>
                                    <ng-container *ngIf="authService.getUserRole() === 'ADHERENT'">
                                        <a routerLink="/book" class="btn btn-sm btn-success">Réserver</a>
                                    </ng-container>
                                </td>
                            </tr>
                            <!-- Slots Listing for Admin -->
                            <tr *ngIf="showSlotsForId">
                                <td colspan="4" class="bg-secondary p-4">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h4 class="mb-0">Créneaux pour le terrain sélectionné</h4>
                                        <button class="btn btn-sm btn-link text-muted"
                                            (click)="showSlotsForId = null">Fermer</button>
                                    </div>
                                    <table class="table table-sm table-white">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Heure</th>
                                                <th>État</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr *ngFor="let s of selectedTerrainSlots">
                                                <td>{{s.date}}</td>
                                                <td>{{s.heureDebut}} - {{s.heureFin}}</td>
                                                <td>
                                                    <span class="badge"
                                                        [ngClass]="s.reserve ? 'badge-warning' : 'badge-success'">
                                                        {{ s.reserve ? 'Réservé' : 'Libre' }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <button *ngIf="!s.reserve" class="btn btn-sm btn-danger py-0"
                                                        (click)="deleteSlot(s.id)">Supprimer</button>
                                                </td>
                                            </tr>
                                            <tr *ngIf="!selectedTerrainSlots.length">
                                                <td colspan="4" class="text-center">Aucun créneau.</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>